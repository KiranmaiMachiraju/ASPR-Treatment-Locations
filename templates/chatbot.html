{% extends "template.html" %}

{% block content %}

<div class="container-fluid py-4">
  <div class="row g-4">
    <!-- Chatbot card -->
    <div class="col-lg-8">
      <div class="card shadow-lg border-0 rounded-3 metallic-card">
        <div class="card-header text-metallic fw-bold">
          üí¨ Treatment Location Chatbot
        </div>
        <div class="card-body d-flex flex-column" style="height: 600px;">
          <!-- Chat window -->
          <div id="chatBox" class="flex-grow-1 overflow-auto p-3 chat-window"></div>

          <!-- Input area -->
          <div class="input-group mt-3">
            <input type="text" id="questionInput" class="form-control input-metallic" placeholder="Ask about locations, medications..." autofocus>
            <button class="btn btn-metallic" type="button" onclick="sendMessage()">Send</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Sidebar instructions -->
    <div class="col-lg-4">
      <div class="card shadow-sm border-0 rounded-3 metallic-card p-3">
        <div class="card-header text-metallic fw-bold">üí° How to Ask</div>
        <div class="card-body">
          <p>Examples of questions you can ask the chatbot:</p>
          <ul>
            <li>Find COVID-19 treatment locations in <strong>GU</strong> or <strong>GA</strong></li>
            <li>List all providers with <strong>Paxlovid</strong></li>
            <li>Where can I get <strong>Lagevrio</strong> in a specific state?</li>
            <li>Show providers with <strong>Veklury</strong> in my area</li>
            <li>Flu vaccination locations in <strong>NY</strong></li>
          </ul>
          <p class="small text-muted">Use <strong>state codes</strong> (e.g., GU, GA, NY) rather than full names for best results.</p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  const chatBox = document.getElementById('chatBox');
  const input = document.getElementById('questionInput');

  function appendMessage(sender, text) {
    const msg = document.createElement('div');
    msg.className = `chat-bubble ${sender}`;
    msg.innerText = text;
    chatBox.appendChild(msg);
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  function sendMessage() {
    const question = input.value.trim();
    if (!question) return;

    appendMessage('user', question);
    input.value = '';

    const thinkingMsg = document.createElement('div');
    thinkingMsg.className = 'chat-bubble bot thinking';
    thinkingMsg.innerText = 'Thinking...';
    chatBox.appendChild(thinkingMsg);
    chatBox.scrollTop = chatBox.scrollHeight;

    fetch(`/api/chatbot?question=${encodeURIComponent(question)}`)
      .then(response => response.json())
      .then(data => {
        thinkingMsg.remove();

        if (Array.isArray(data.answer)) {
          data.answer.forEach(part => appendMessage('bot', part));
        } else {
          appendMessage('bot', data.answer);
        }
      })
      .catch(error => {
        thinkingMsg.remove();
        console.error('Chatbot error:', error);
        appendMessage('bot', '‚ö†Ô∏è Sorry, there was an error processing your request.');
      });
  }

  input.addEventListener('keypress', function (e) {
    if (e.key === 'Enter') {
      sendMessage();
    }
  });
</script>
{% endblock %}
